version: "3.8"
## See https://github.com/compose-spec/compose-spec/blob/master/spec.md

## Templates
x-build-args:
  &default-my-build-args
  ALPINE_TAG: ${ALPINE_TAG}
  DEV_USER: ${DEV_USER}
  DEV_UID: "${DEV_UID:?'Missing DEV_UID Run DEV_UID=$(id -u) DEV_GID=$(id -g) docker-compose build [options]'}"
  DEV_GID: "${DEV_GID}"

x-build-args-xdg_x:
  &default-build-args-xdg-x
  STD_XDG_DATA_HOME:
  STD_XDG_CONFIG_HOME:

x-base-developer:
  &default-base-developer
  build:
    context: .
    dockerfile: Dockerfile-base-developer
    args:
      << : *default-my-build-args
  image: ${DOCKER_REGISTY_AND_PATH:-}base-developer:latest

x-tmux-developer:
  &default-tmux-developer
  image: ${DOCKER_REGISTY_AND_PATH}tmux-developer:latest
  build: 
    context: .
    dockerfile: Dockerfile-tmux
    #target: toolchain
    #target: tmux-build
    args:
      << : *default-my-build-args
      << : *default-build-args-xdg-x
  hostname: tmux-docker
  volumes:
    - projects:/projects
    - tmux-ressurect:/home/${DEV_USER}/.tmux/resurrect

x-nvim-developer:
  &default-nvim-developer
  image: ${DOCKER_REGISTY_AND_PATH}nvim-developer:latest
  build:
    context: .
    dockerfile: Dockerfile-nvim
    #target: toolchain
    #target: neovim-build
    args:
      << : *default-my-build-args
      << : *default-build-args-xdg-x
  volumes:
    - projects:/projects

## Services
services:
  base-developer_latest:
    *default-base-developer
  base-developer_specific:
    << : *default-base-developer
    image: ${DOCKER_REGISTY_AND_PATH:-}base-developer:${ALPINE_TAG}
  nvim-developer_latest:
    *default-nvim-developer
  nvim-developer_specific:
    <<  : *default-nvim-developer
    image: ${DOCKER_REGISTY_AND_PATH}nvim-developer:${NEOVIM_DOCKER_TAG}
  tmux-developer_latest:
    *default-tmux-developer
  tmux-developer_specific:
    <<  : *default-tmux-developer
    image: ${DOCKER_REGISTY_AND_PATH}tmux-developer:${TMUX_DOCKER_TAG}
  # vscode-developer:
  #     build:
  #         context: .
  #         dockerfile: Dockerfile-vscode
  # rider-developer:
  #     build:
  #         context: .
  #         dockerfile: Dockerfile-rider

volumes:
## Mapping to localhost
## https://blog.code4hire.com/2018/06/define-named-volume-with-host-mount-in-the-docker-compose-file/
  projects:
    driver: local
    driver_opts:
      type: none
      device: ${PROJECTS_HOST_PATH}
      o: bind
  tmux-ressurect:
    driver: local
    driver_opts:
      type: none
      device: ${TMUX_RESURRECT_HOST_PATH}
      o: bind
## Mapping just to a named volume inside docker
#  projects:
#  tmux-ressurect:
